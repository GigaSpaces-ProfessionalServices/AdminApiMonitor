<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:os-core="http://www.openspaces.org/schema/core"
       xmlns:os-remoting="http://www.openspaces.org/schema/remoting"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd
       http://www.openspaces.org/schema/core http://www.openspaces.org/schema/9.7/core/openspaces-core.xsd
       http://www.openspaces.org/schema/remoting http://www.openspaces.org/schema/9.7/remoting/openspaces-remoting.xsd">

    <context:annotation-config />
    <os-core:giga-space-context/>
    <os-remoting:annotation-support />
    <context:component-scan base-package="com.belk.catalogcache.clientonly"/>
    <context:component-scan base-package="com.belk.catalogcache.domain"/>

    <context:property-placeholder location="classpath:admin_api.properties" />

    <os-core:space id="space" url="jini://*/*/${spaceMonitor.spaceName}?locators=${spaceMonitor.locators}&amp;groups=${spaceMonitor.groups}" />
    <os-core:distributed-tx-manager id="transactionManager"/>
    <os-core:giga-space id="real_gigaSpace" space="space" tx-manager="transactionManager"/>

            <!--PERFORMANCE INTERCEPTOR START-->
    <bean id="logInterceptor" class="com.gigaspaces.monitoring.metrics_source.space_proxy.LogInterceptor" >
    <property name="exposer" ref="logExposer" />
    </bean>

    <bean id="logExposer" class="com.gigaspaces.monitoring.metrics_source.space_proxy.LoggingMeasurementExposer">
    <property name="spaceProxyCounter" ref="spaceProxyCounter" />
    </bean>

    <bean id="spaceMonitor" class="com.gigaspaces.monitoring.metrics_source.adminapi.AdminAPIMonitor" init-method="init">
    <property name="adminUser" value="${spaceMonitor.adminUser}" />
    <property name="adminPassword" value="${spaceMonitor.adminPassword}" />
    <property name="locators" value="${spaceMonitor.locators}" />
    <property name="secured" value="${spaceMonitor.secured}" />
    <property name="groups" value="${spaceMonitor.groups}" />
    <property name="spaceName" value="${spaceMonitor.spaceName}" />
    <property name="averageCounter" ref="averageCounter" />
    </bean>

    <bean id="spaceProxyCounter" class="com.gigaspaces.monitoring.metrics_source.space_proxy.SpaceProxyCounter">
        <property name="averageCounter" ref="averageCounter" />
    </bean>

    <bean id="averageCounter" class="com.gigaspaces.monitoring.metrics_source.counter.ExponentialAverageCounter">
    <property name="alpha" value="${stat.sample.alpha}" />
    </bean>

    <bean id="collectPeriodicMetricsTask" class="com.gigaspaces.monitoring.metrics_reporter.CollectPeriodicAverageMetricsTask" >
        <property name="spaceProxyCounter" ref="spaceProxyCounter" />
        <property name="adminMonitor" ref="spaceMonitor" />
        <property name="collectionPeriod" value="${stat.periodic.sample.interval}" />
        <property name="logFileLocation" value="${stat.periodic.log.file}" />
    </bean>

    <bean id="schedulerPeriodicTask" class="org.springframework.scheduling.timer.MethodInvokingTimerTaskFactoryBean">
    <property name="targetObject" ref="collectPeriodicMetricsTask" />
    <property name="targetMethod" value="collectMetrics" />
    </bean>

    <bean id="timerPeriodicTask" class="org.springframework.scheduling.timer.ScheduledTimerTask">
    <property name="timerTask" ref="schedulerPeriodicTask" />
    <property name="period" value="${stat.periodic.sample.interval}" />
    <property name="delay" value="${stat.periodic.sample.delay}" />
    </bean>

    <bean class="org.springframework.scheduling.timer.TimerFactoryBean">
    <property name="scheduledTimerTasks">
        <list>
            <ref local="timerPeriodicTask" />
        </list>
    </property>
    </bean>

    <bean id="wrappedGigaSpace" class="org.springframework.aop.framework.ProxyFactoryBean">

    <property name="target" ref="real_gigaSpace" />

    <property name="interceptorNames">
        <list>
            <value>logInterceptor</value>
        </list>
    </property>
    </bean>
            <!--PERFORMANCE INTERCEPTOR END-->

</beans>